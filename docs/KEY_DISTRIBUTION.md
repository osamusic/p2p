# è‡ªå‹•éµé…å¸ƒã‚·ã‚¹ãƒ†ãƒ  (Automated Key Distribution)

## æ¦‚è¦ (Overview)

P2PåŒæœŸã‚·ã‚¹ãƒ†ãƒ ã«å®Ÿè£…ã•ã‚ŒãŸè‡ªå‹•éµé…å¸ƒæ©Ÿèƒ½ã«ã‚ˆã‚Šã€ãƒ”ã‚¢é–“ã§å…¬é–‹éµã‚’è‡ªå‹•çš„ã«ç™ºè¦‹ãƒ»äº¤æ›ã§ãã¾ã™ã€‚

The automated key distribution system enables automatic discovery and exchange of public keys between peers in the P2P synchronization system.

## æ©Ÿèƒ½ (Features)

### ğŸ”‘ éµé…å¸ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (Key Distribution Messages)

| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ— | èª¬æ˜ | ç”¨é€” |
|------------------|------|------|
| `KeyRequest` | å…¬é–‹éµã®è¦æ±‚ | ç‰¹å®šã®ãƒ”ã‚¢ã®å…¬é–‹éµã‚’å–å¾— |
| `KeyResponse` | å…¬é–‹éµã®å¿œç­” | è¦æ±‚ã«å¯¾ã™ã‚‹å…¬é–‹éµã®æä¾› |
| `KeyAnnouncement` | å…¬é–‹éµã®é€šçŸ¥ | è‡ªåˆ†ã®å…¬é–‹éµã‚’ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é€šçŸ¥ |
| `WhitelistRequest` | ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆè¦æ±‚ | æ–°ã—ã„ãƒ”ã‚¢ãŒãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆè¿½åŠ ã‚’è¦æ±‚ |

### ğŸ› ï¸ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒãƒ³ãƒ‰ (Interactive Commands)

ãƒãƒ¼ãƒ‰å®Ÿè¡Œä¸­ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼š

```bash
# è‡ªåˆ†ã®å…¬é–‹éµã‚’ã™ã¹ã¦ã®ãƒ”ã‚¢ã«é€šçŸ¥
> announce-key
âœ“ Announced public key to all peers

# æ¬ è½ã—ã¦ã„ã‚‹å…¬é–‹éµã‚’è‡ªå‹•çš„ã«è¦æ±‚
> request-keys
âœ“ Requested 3 missing public key(s)

# ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã¸ã®è¿½åŠ ã‚’è¦æ±‚
> request-whitelist
Enter your name (optional): MyNode
âœ“ Sent whitelist request to all peers
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (Security)

### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

1. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ‰åŠ¹æœŸé™**: 24æ™‚é–“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœ‰åŠ¹æœŸé™
2. **ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢**: é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œå‡ºã¨æ‹’å¦
3. **ç½²åæ¤œè¨¼**: Ed25519ç½²åã«ã‚ˆã‚‹å®Œå…¨æ€§æ¤œè¨¼
4. **ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆèªè¨¼**: æ‰¿èªã•ã‚ŒãŸãƒ”ã‚¢é–“ã®ã¿ã®éµäº¤æ›

### ğŸ›¡ï¸ æ¤œè¨¼ãƒ—ãƒ­ã‚»ã‚¹

```
1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ â†’ 2. æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ â†’ 3. ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒãƒã‚§ãƒƒã‚¯
       â†“
4. ç½²åæ¤œè¨¼ â†’ 5. ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç¢ºèª â†’ 6. å…¬é–‹éµæ¤œè¨¼
       â†“
7. å‡¦ç†å®Ÿè¡Œ â†’ 8. å¿…è¦ã«å¿œã˜ã¦å¿œç­”
```

## è¨­å®š (Configuration)

### KeyDistributionConfig

```rust
pub struct KeyDistributionConfig {
    /// è‡ªå‹•éµå…±æœ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    pub auto_share_keys: bool,           // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
    
    /// è‡ªå‹•éµè¦æ±‚ã‚’æœ‰åŠ¹ã«ã™ã‚‹  
    pub auto_request_keys: bool,         // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
    
    /// ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆè¦æ±‚ã®å—ã‘å…¥ã‚Œ
    pub accept_whitelist_requests: bool, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: false
    
    /// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ‰åŠ¹æœŸé™ï¼ˆæ™‚é–“ï¼‰
    pub max_message_age_hours: u64,      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 24
}
```

## ä½¿ç”¨ä¾‹ (Usage Examples)

### ã‚·ãƒŠãƒªã‚ª1: æ–°ã—ã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹ç¯‰

```bash
# ãƒãƒ¼ãƒ‰Aèµ·å‹•
p2p-sync start --port 8000

# ãƒãƒ¼ãƒ‰Bèµ·å‹•  
p2p-sync start --port 8001 --dial /ip4/127.0.0.1/tcp/8000

# ãƒãƒ¼ãƒ‰Aã§Bã‚’ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ 
p2p-sync whitelist add <NodeB_PeerID> -n "NodeB"

# ãƒãƒ¼ãƒ‰Bã§Aã‚’ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ 
p2p-sync whitelist add <NodeA_PeerID> -n "NodeA"

# å„ãƒãƒ¼ãƒ‰ã§å…¬é–‹éµã‚’è‡ªå‹•é…å¸ƒ
> announce-key
> request-keys
```

### ã‚·ãƒŠãƒªã‚ª2: æ—¢å­˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®å‚åŠ 

```bash
# æ–°ã—ã„ãƒãƒ¼ãƒ‰èµ·å‹•
p2p-sync start --dial /ip4/existing-node/tcp/8000

# æ—¢å­˜ãƒãƒ¼ãƒ‰ã«ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆè¿½åŠ ã‚’è¦æ±‚
> request-whitelist
Enter your name (optional): NewNode

# ç®¡ç†è€…ãŒæ‰‹å‹•ã§ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ å¾Œã€éµã‚’è¦æ±‚
> request-keys
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (Troubleshooting)

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **"Message from non-whitelisted peer"**
   - è§£æ±ºç­–: é€ä¿¡è€…ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹
   - ã‚³ãƒãƒ³ãƒ‰: `p2p-sync whitelist add <peer_id>`

2. **"Invalid signature from peer"**
   - è§£æ±ºç­–: å…¬é–‹éµã‚’å†å–å¾—ã™ã‚‹
   - ã‚³ãƒãƒ³ãƒ‰: `request-keys`

3. **"Ignoring old key distribution message"**
   - è§£æ±ºç­–: æ™‚åˆ»åŒæœŸã‚’ç¢ºèªã™ã‚‹
   - ãƒ’ãƒ³ãƒˆ: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯24æ™‚é–“ã§æœŸé™åˆ‡ã‚Œ

### ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

è©³ç´°ãªãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ï¼š

```bash
RUST_LOG=info p2p-sync start
```

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (Architecture)

### éµé…å¸ƒãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    KeyRequest     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Peer A    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚   Peer B    â”‚
â”‚             â”‚                   â”‚             â”‚
â”‚             â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    KeyResponse    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ 

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum KeyDistributionMessage {
    KeyRequest {
        requestor: String,      // è¦æ±‚è€…ã®Peer ID
        target: String,         // è¦æ±‚å¯¾è±¡ã®Peer ID  
        timestamp: DateTime<Utc>,
    },
    KeyResponse {
        target: String,         // å¯¾è±¡ã®Peer ID
        public_key: Vec<u8>,    // ãƒ—ãƒ­ãƒˆãƒãƒƒãƒ•ã‚¡å½¢å¼ã®å…¬é–‹éµ
        timestamp: DateTime<Utc>,
    },
    // ... ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—
}
```

## ä»Šå¾Œã®è¨ˆç”» (Future Plans)

- [x] ä¿¡é ¼ãƒã‚§ãƒ¼ãƒ³ã«ã‚ˆã‚‹ç›¸äº’èªè¨¼ âœ… **å®Ÿè£…å®Œäº†!**
- [ ] éµã®å®šæœŸå›è»¢æ©Ÿèƒ½
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…¨ä½“ã§ã®éµé…å¸ƒçµ±è¨ˆ
- [ ] éšå±¤çš„ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç®¡ç†

## ğŸ†• å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ (v0.2.0)

### **ã‚·ãƒ³ãƒ—ãƒ«ä¿¡é ¼ãƒã‚§ãƒ¼ãƒ³ã‚·ã‚¹ãƒ†ãƒ **

åŸºæœ¬çš„ãªä¿¡é ¼æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ ãŒå®Ÿè£…ã•ã‚Œã¾ã—ãŸï¼š

```bash
# æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰
> recommend-peer 12D3Koo...ABC  # ãƒ”ã‚¢ã‚’æ¨è–¦
> cleanup                        # ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—  
> reload-cache                   # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†èª­ã¿è¾¼ã¿
```

### **ä¿¡é ¼é–¢ä¿‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**

ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆãŒæ‹¡å¼µã•ã‚Œã€æ¨è–¦æƒ…å ±ã‚’ä¿å­˜ï¼š

```sql
-- æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
recommended_by TEXT DEFAULT '[]'        -- æ¨è–¦è€…ãƒªã‚¹ãƒˆ (JSON)
recommendation_count INTEGER DEFAULT 0  -- æ¨è–¦æ•°
```